---
title: "Long-term Monitoring and Reporting"
subtitle: "ReefCloud Training - Brunei"
date: Sys.date()
author: "Australian Institute of Marine Science"
crossref:
  lof-title: "List of Figures"
format: 
  PrettyPDF-pdf:
    fig-pos: "H"
output-file: "Long-TermMonitoringReport-Brunei"
output-ext: "pdf"
mainfont: Arial
engine: knitr
execute:
  eval: true
---

## Introduction


## Methodology



```{r}
#| label: PrepareWorkspace
#| echo: false
#| include: false

library(caret)
library(tidyverse)
library(ggthemes)
library(gt)

##Plot theme
theme_Publication <- function(base_size=14, base_family="sans") {
      library(grid)
      library(ggthemes)
      (theme_foundation(base_size=base_size, base_family=base_family)
       + theme(plot.title = element_text(face = "bold",
                                         size = rel(0.8), hjust = 0.5),
               text = element_text(),
               panel.background = element_rect(colour = NA),
               plot.background = element_rect(colour = NA),
               panel.border = element_rect(colour = NA),
               axis.title = element_text(face = "bold",size = rel(1)),
               axis.title.y = element_text(angle=90,vjust =2),
               axis.title.x = element_text(vjust = -0.2),
               axis.text = element_text(), 
               axis.line = element_line(colour="black"),
               axis.ticks = element_line(),
               panel.grid.major = element_line(colour="#f0f0f0"),
               panel.grid.minor = element_blank(),
               legend.key = element_rect(colour = NA),
               legend.position = "bottom",
               legend.direction = "horizontal",
               legend.key.size= unit(0.2, "cm"),
               legend.margin = unit(0, "cm"),
               legend.title = element_text(face="italic"),
               plot.margin=unit(c(10,5,5,5),"mm"),
               strip.background=element_rect(colour="#f0f0f0",fill="#f0f0f0"),
               strip.text = element_text(face="bold")
          ))
      
}

scale_fill_Publication <- function(...){
      library(scales)
      discrete_scale("fill","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)

}

scale_colour_Publication <- function(...){
      library(scales)
      discrete_scale("colour","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)

}
```


```{r}
#| label: LoadDatat3
#| echo: false
#| include: false
labelset_t3 <- read.csv("../data/Brunei_project/Labelset-T3.csv", 
                     header =  TRUE) |> 
  rename(classification = CODE,
         label = DESCRIPTION,
         groupcode = FUNCTIONAL.GROUP) |> 
  select(classification, label, groupcode)

data_t3_long <- read.csv("../data/Brunei_project/Project-T3.csv", 
                header = TRUE) |> 
  select(site_id,
       site_latitude, 
       site_longitude, 
       site_reef_name,
       survey_id, 
       survey_title, 
       survey_start_date..UTC., 
       survey_depth, 
       survey_transect_number,
       image_id, 
       image_disabled, 
       point_id, 
       point_num, 
       point_machine_classification, 
       point_human_classification, 
       point_human_group_code) |> 
  mutate(year = year(survey_start_date..UTC.), #create year month date id
         month = month(survey_start_date..UTC.), 
         date = date(survey_start_date..UTC.),
         transect_id = paste(site_id, 
                             year(survey_start_date..UTC.), 
                             survey_transect_number, 
                             sep = "_")) |> 
  select(-survey_start_date..UTC.) |> 
  filter(image_disabled == "False") |> 
  select(-image_disabled) |> 
  pivot_longer(cols = matches("point_.*_classification"), 
               names_to = "type",
               values_to = "classification") |>
  left_join(labelset_t3)

data_t3_long <- data_t3_long |> 
  mutate(site_reef_name = case_when(
    site_reef_name == "Pelong Rock" ~ "Pelong Rock",
    site_reef_name == "pelong rock RCB" ~ "Pelong Rock",
    site_reef_name == "Abana Reef" ~ "Abana Reef",
    site_reef_name == "Amcotts Rock" ~ "Amcotts Rock",
    site_reef_name == "Brunei Patches" ~ "Brunei Patches",
    site_reef_name == "Two Fathom Rock" ~ "Two Fathom Rock"
  ))

data_t3_long <- data_t3_long |> 
  mutate(groupcode = case_when(
    groupcode == "BL_HC" ~ "HC",
    groupcode == "CA" ~ "CA",
    groupcode == "CM" ~ "CM",
    groupcode == "HC" ~ "HC",
    groupcode == "MA" ~ "MA",
    groupcode == "MI" ~ "MI",
    groupcode == "OT" ~ "OT",
    groupcode == "SC" ~ "SC",
    groupcode == "SI" ~ "SI",
    groupcode == "SP" ~ "SP",
    groupcode == "SS" ~ "SS",
    groupcode == "TA" ~ "TA",
    groupcode == "UN" ~ "UN"
  )) |> 
  filter(groupcode != "NA")

data_t3_long <- data_t3_long |> 
  mutate(season = case_when(
    month >= 4 & month <= 9 ~ "Apr-Sep",
    month >= 10 | month <= 3 ~ "Oct-Mar"
  ))

data_t3_long <- data_t3_long |> 
  mutate(protection = case_when(
    site_reef_name == "Abana Reef" ~ "Protected",
    site_reef_name == "Amcotts Rock" ~ "Not Protected",
    site_reef_name == "Brunei Patches" ~ "Not Protected",
    site_reef_name == "Pelong Rock" ~ "Protected",
    site_reef_name == "Two Fathom Rock" ~ "Not Protected"
  ))


data_t3_cover <- data_t3_long |> 
    group_by(across(c(starts_with("site"),
                    starts_with("survey"),
                    type, 
                    date,
                    year,
                    date,
                    season,
                    protection,
                    transect_id,
                    groupcode))
  ) |> 
  summarise(count = n(), .groups = "keep") |> 
  ungroup(groupcode) |>
  mutate(total = sum(count)) |>
  ungroup()

allgroup <- data_t3_cover |>  pull(groupcode) |>  unique()

filler.group <- data_t3_cover |> 
  dplyr::select(c(starts_with("site"),
                    starts_with("survey"),
                    type, 
                    date,
                    year,
                    date,
                    season,
                    transect_id,
                    groupcode)
  ) |> 
  distinct() |> 
  tidyr::crossing(group_code = allgroup)

data_t3_cover <- data_t3_cover |> 
  full_join(filler.group) |> 
  group_by(
    across(c(starts_with("site"),
                    starts_with("survey"),
                    type, 
                    date,
                    year,
                    date,
                    season,
                    protection,
                    transect_id,
                    groupcode
    ))) |> 
  mutate(count = ifelse(is.na(count), 0, count),
         cover = count/total*100)

data_t3_diversity <- data_t3_long |> 
    group_by(across(c(starts_with("site"),
                    starts_with("survey"),
                    type, 
                    date,
                    year,
                    date,
                    season,
                    protection,
                    transect_id,
                    classification,
                    groupcode
                    ))
  ) |> 
  summarise(count = n(), .groups = "keep") |> 
  ungroup(classification) |>
  mutate(total = sum(count)) |>
  ungroup()

allclass <- data_t3_diversity |>  pull(classification) |>  unique()

filler.class <- data_t3_diversity |> 
  dplyr::select(c(starts_with("site"),
                    starts_with("survey"),
                    type, 
                    date,
                    year,
                    date,
                    season,
                    transect_id
  )) |> 
  distinct() |> 
  tidyr::crossing(classification = allclass)

data_t3_diversity <- data_t3_diversity |> 
  full_join(filler.class) |> 
  group_by(
    across(c(starts_with("site"),
                    starts_with("survey"),
                    type, 
                    date,
                    year,
                    date,
                    season,
                    protection,
                    transect_id    
             ))) |> 
  mutate(count = ifelse(is.na(count), 0, count),
         cover = count/total*100)
```


```{r}
#| label: coralcovertime
#| echo: false
#| include: false
ggplot(data_t3_cover |>  
         filter(type == "point_machine_classification",
                groupcode == "HC")) +
  geom_point(aes(x = year, y = cover)) +
  geom_smooth(aes(x = year, y = cover), method = "lm") +
  facet_wrap(~ site_reef_name) +
  labs(x = "Time",
       y = "Hardcoral cover (%)",
       title = "Hardcoral cover across time") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))
```
Hard coral cover changes at the different sites shows different trends through time. In particular, Amcotts Rock show the largest rate of decline.

```{r}
#| label: macroalgaecovertime
#| echo: false
#| include: false
ggplot(data_t3_cover |>  
         filter(type == "point_machine_classification",
                groupcode == "MA")) +
  geom_point(aes(x = year, y = cover)) +
  geom_smooth(aes(x = year, y = cover), method = "lm") +
  facet_wrap(~ site_reef_name) +
  labs(x = "Time",
       y = "Macroalgae cover (%)",
       title = "Macroalgae cover across time") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))
```
Macroalgae cover changes at the different sites shows different trends through time. In particular, Abana Reef show the largest rate of decline.

```{r}
#| label: calculateGenusDiversity
#| echo: false
#| include: false
data_t3_diversitycount <- 
  data_t3_diversity |>  
  filter(groupcode == "HC") |> 
  group_by(across(site_id:transect_id)) |> 
  summarise(diversity = n())
```

```{r}
#| label: calculateGenusDiversity
#| echo: false
#| include: false
ggplot(data_t3_diversitycount |> 
         filter(type == "point_machine_classification")) +
  geom_boxplot(aes(x = year, y = diversity)) +
  facet_grid(~ site_reef_name) +
  labs(x = "Time",
       y = "No. of Hardcoral Genus",
       title = "Hardcoral genus at different sites") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))
```

Hard coral genus at different sites show different patterns. Abana Reef has the most number of hard coral genera, compared to other sites.

```{r}
#| label: calculateGenusDiversityProtectedareas
#| echo: false
#| include: false
ggplot(data_t3_diversitycount |> 
         filter(type == "point_machine_classification")) +
  geom_boxplot(aes(x = year, y = diversity)) +
  facet_grid(~ protection) +
  labs(x = "Time",
       y = "No. of Hardcoral Genus",
       title = "Hardcoral genus at different protection zones") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))
```


